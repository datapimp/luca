/**
 * Supported keybindings:
 *
 *   Motion:
 *   h, j, k, l
 *   e, E, w, W, b, B, ge, gE
 *   f<character>, F<character>, t<character>, T<character>
 *   $, ^, 0
 *   gg, G
 *   %
 *   '<character>, `<character>
 *
 *   Operator:
 *   d, y, c
 *   dd, yy, cc
 *   g~, g~g~
 *   >, <, >>, <<
 *
 *   Operator-Motion:
 *   x, X, D, Y, C, ~
 *
 *   Action:
 *   a, i, s, A, I, S, o, O
 *   J
 *   u, Ctrl-r
 *   m<character>
 *   r<character>
 *
 *   Modes:
 *   ESC - leave insert mode, visual mode, and clear input state.
 *   Ctrl-[, Ctrl-c - same as ESC.
 *
 * Registers: unamed, -, a-z, A-Z, 0-9
 *   (Does not respect the special case for number registers when delete
 *    operator is made with these commands: %, (, ),  , /, ?, n, N, {, } )
 *   TODO: Implement the remaining registers.
 * Marks: a-z, A-Z, and 0-9
 *   TODO: Implement the remaining special marks. They have more complex
 *       behavior.
 *
 * Code structure:
 *  1. Default keymap
 *  2. Variable declarations and short basic helpers
 *  3. Instance (External API) implementation
 *  4. Internal state tracking objects (input state, counter) implementation
 *     and instanstiation
 *  5. Key handler (the main command dispatcher) implementation
 *  6. Motion, operator, and action implementations
 *  7. Helper functions for the key handler, motions, operators, and actions
 *  8. Set up Vim to work as a keymap for CodeMirror.
 */
(function(){"use strict";var e=[{keys:["Left"],type:"keyToKey",toKeys:["h"]},{keys:["Right"],type:"keyToKey",toKeys:["l"]},{keys:["Up"],type:"keyToKey",toKeys:["k"]},{keys:["Down"],type:"keyToKey",toKeys:["j"]},{keys:["Space"],type:"keyToKey",toKeys:["l"]},{keys:["Backspace"],type:"keyToKey",toKeys:["h"]},{keys:["Ctrl-Space"],type:"keyToKey",toKeys:["W"]},{keys:["Ctrl-Backspace"],type:"keyToKey",toKeys:["B"]},{keys:["Shift-Space"],type:"keyToKey",toKeys:["w"]},{keys:["Shift-Backspace"],type:"keyToKey",toKeys:["b"]},{keys:["Ctrl-n"],type:"keyToKey",toKeys:["j"]},{keys:["Ctrl-p"],type:"keyToKey",toKeys:["k"]},{keys:["Ctrl-["],type:"keyToKey",toKeys:["Esc"]},{keys:["Ctrl-c"],type:"keyToKey",toKeys:["Esc"]},{keys:["s"],type:"keyToKey",toKeys:["c","l"]},{keys:["S"],type:"keyToKey",toKeys:["c","c"]},{keys:["Home"],type:"keyToKey",toKeys:["0"]},{keys:["End"],type:"keyToKey",toKeys:["$"]},{keys:["PageUp"],type:"keyToKey",toKeys:["Ctrl-b"]},{keys:["PageDown"],type:"keyToKey",toKeys:["Ctrl-f"]},{keys:["h"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!1}},{keys:["l"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["j"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,linewise:!0}},{keys:["k"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,linewise:!0}},{keys:["w"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1}},{keys:["W"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1,bigWord:!0}},{keys:["e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,inclusive:!0}},{keys:["E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["b"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1}},{keys:["B"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1,bigWord:!0}},{keys:["g","e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,inclusive:!0}},{keys:["g","E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["{"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!1}},{keys:["}"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!0}},{keys:["Ctrl-f"],type:"motion",motion:"moveByPage",motionArgs:{forward:!0}},{keys:["Ctrl-b"],type:"motion",motion:"moveByPage",motionArgs:{forward:!1}},{keys:["g","g"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0}},{keys:["G"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!0,explicitRepeat:!0,linewise:!0}},{keys:["0"],type:"motion",motion:"moveToStartOfLine"},{keys:["^"],type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["$"],type:"motion",motion:"moveToEol",motionArgs:{inclusive:!0}},{keys:["%"],type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:!0}},{keys:["f","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["F","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!1}},{keys:["t","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["T","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!1}},{keys:["'","character"],type:"motion",motion:"goToMark"},{keys:["`","character"],type:"motion",motion:"goToMark"},{keys:["|"],type:"motion",motion:"moveToColumn",motionArgs:{}},{keys:["d"],type:"operator",operator:"delete"},{keys:["y"],type:"operator",operator:"yank"},{keys:["c"],type:"operator",operator:"change",operatorArgs:{enterInsertMode:!0}},{keys:[">"],type:"operator",operator:"indent",operatorArgs:{indentRight:!0}},{keys:["<"],type:"operator",operator:"indent",operatorArgs:{indentRight:!1}},{keys:["g","~"],type:"operator",operator:"swapcase"},{keys:["n"],type:"motion",motion:"findNext"},{keys:["N"],type:"motion",motion:"findPrev"},{keys:["x"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!0},operatorMotionArgs:{visualLine:!1}},{keys:["X"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!1},operatorMotionArgs:{visualLine:!0}},{keys:["D"],type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["Y"],type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["C"],type:"operatorMotion",operator:"change",operatorArgs:{enterInsertMode:!0},motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["~"],type:"operatorMotion",operator:"swapcase",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["a"],type:"action",action:"enterInsertMode",actionArgs:{insertAt:"charAfter"}},{keys:["A"],type:"action",action:"enterInsertMode",actionArgs:{insertAt:"eol"}},{keys:["i"],type:"action",action:"enterInsertMode"},{keys:["I"],type:"action",action:"enterInsertMode",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["o"],type:"action",action:"newLineAndEnterInsertMode",actionArgs:{after:!0}},{keys:["O"],type:"action",action:"newLineAndEnterInsertMode",actionArgs:{after:!1}},{keys:["v"],type:"action",action:"toggleVisualMode"},{keys:["V"],type:"action",action:"toggleVisualMode",actionArgs:{linewise:!0}},{keys:["J"],type:"action",action:"joinLines"},{keys:["p"],type:"action",action:"paste",actionArgs:{after:!0}},{keys:["P"],type:"action",action:"paste",actionArgs:{after:!1}},{keys:["r","character"],type:"action",action:"replace"},{keys:["u"],type:"action",action:"undo"},{keys:["Ctrl-r"],type:"action",action:"redo"},{keys:["m","character"],type:"action",action:"setMark"},{keys:['"',"character"],type:"action",action:"setRegister"},{keys:[",","/"],type:"action",action:"clearSearchHighlight"},{keys:["a","character"],type:"motion",motion:"textObjectManipulation"},{keys:["i","character"],type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:!0}},{keys:["/"],type:"search",searchArgs:{forward:!0,querySrc:"prompt"}},{keys:["?"],type:"search",searchArgs:{forward:!1,querySrc:"prompt"}},{keys:["*"],type:"search",searchArgs:{forward:!0,querySrc:"wordUnderCursor"}},{keys:["#"],type:"search",searchArgs:{forward:!1,querySrc:"wordUnderCursor"}},{keys:[":"],type:"ex"}],t=function(){function a(e,t){var n=[];for(var r=e;r<e+t;r++)n.push(String.fromCharCode(r));return n}function g(e){return r.test(e)}function y(e,t){return t>=0&&t<e.lineCount()}function b(e){return/^[a-z]$/.test(e)}function w(e){return"()[]{}".indexOf(e)!=-1}function E(e){return i.test(e)}function S(e){return/^[A-Z]$/.test(e)}function x(e){return/^[\w]$/.test(e)}function T(e){return s.test(e)}function N(e){return/^\s*$/.test(e)}function C(e,t,n){return e>=t&&e<=n}function k(e,t){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1}function A(){return L||(L={searchQuery:null,searchIsReversed:!1,registerController:new P({})}),L}function O(e){return e.vimState||(e.vimState={inputState:new _,lastHPos:-1,lastMotion:null,marks:{},visualMode:!1,visualLine:!1}),e.vimState}function _(){this.reset()}function D(e,t){this.clear(),e&&this.set(e,t)}function P(e){this.registers=e,this.unamedRegister=e['"']=new D}function q(e,t,n){var r=Math.min(Math.max(0,t.line),e.lineCount()-1),i=G(e,r)-1;i=n?i+1:i;var s=Math.min(Math.max(0,t.ch),i);return{line:r,ch:s}}function R(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function U(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function z(e,t,n){return{line:e.line+t,ch:e.ch+n}}function W(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function X(e,t){for(var n=0;n<e.length;n++)if(e[n]!=t[n]&&t[n]!="character")return!1;return!0}function V(e,t){for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function $(e,t,n){return function(){for(var r=0;r<n;r++)t(e)}}function J(e){return{line:e.line,ch:e.ch}}function K(e,t){return e.ch==t.ch&&e.line==t.line}function Q(e,t){return e.line<t.line?!0:e.line==t.line&&e.ch<t.ch?!0:!1}function G(e,t){return e.getLine(t).length}function Y(e){return e.split("").reverse().join("")}function Z(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function et(e){return e.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function tt(e,t){t.visualMode=!1,t.visualLine=!1;var n=e.getCursor("anchor"),r=e.getCursor("head");K(n,r)||e.setCursor(q(e,r))}function nt(e,t,n){var r=e.getRange(t,n),i=r.split("\n");i.length>1&&N(i.pop())&&(n.line--,n.ch=G(e,n.line))}function rt(e,t,n){t.ch=0,n.ch=0,n.line++}function it(e){if(!e)return 0;var t=e.search(/\S/);return t==-1?e.length:t}function st(e,t,n,r,i){var s=e.getCursor(),o=e.getLine(s.line),u=s.ch,a=o.substring(u),f;i?f=a.search(/\w/):f=a.search(/\S/);if(f==-1)return null;u+=f,a=o.substring(u);var l=o.substring(0,u),c;r?c=/^\S+/:/\w/.test(o.charAt(u))?c=/^\w+/:c=/^[^\w\s]+/;var h=c.exec(a),p=u,d=u+h[0].length-1,v=c.exec(Y(l));return v&&(p-=v[0].length),t&&d++,{start:{line:s.line,ch:p},end:{line:s.line,ch:d}}}function ot(e,t,n,r){var i=t.line,s=t.ch,a=e.getLine(i),f=n?1:-1,l=r?u:o;for(;;){var c=f>0?a.length:-1,h=c,p=c;while(s!=c){var d=!1;for(var v=0;v<l.length&&!d;++v)if(l[v].test(a.charAt(s))){h=s;while(s!=c&&l[v].test(a.charAt(s)))s+=f;p=s,d=h!=p;if(h==t.ch&&i==t.line&&p==h+f)continue;return{from:Math.min(h,p+1),to:Math.max(h,p),line:i}}d||(s+=f)}i+=f;if(!y(e,i))return null;a=e.getLine(i),s=f>0?0:a.length}throw"The impossible happened."}function ut(e,t,n,r,i){var s=e.getCursor();for(var o=0;o<t;o++){var u=s.ch,a=s.line,f,l=!1;while(!l){f=ot(e,s,n,i),l=!0;if(!f)return n?{line:s.line,ch:G(e,s.line)}:{line:s.line,ch:0};s.line=f.line,n&&r?s.ch=f.to-1:n&&!r?C(s.ch,f.from,f.to)&&f.line==a?(l=!1,s.ch=f.to-1):s.ch=f.from:!n&&r?C(s.ch,f.from,f.to)&&f.line==a?(l=!1,s.ch=f.from):s.ch=f.to:!n&&!r&&(s.ch=f.from)}}return s}function at(e,t,n,r){var i=e.getCursor(),s=i.ch,o;for(var u=0;u<t;u++){var a=e.getLine(i.line);o=ct(s,a,r,n,!0);if(o==-1)return i;s=o}return{line:e.getCursor().line,ch:o}}function ft(e,t){var n=e.getCursor().line;return q(e,{line:n,ch:t-1})}function lt(e,t,n,r){if(!k(n,v))return;t.marks[n]&&t.marks[n].clear(),t.marks[n]=e.setBookmark(r)}function ct(e,t,n,r,i){var s;return r?(s=t.indexOf(n,e+1),s!=-1&&!i&&(s-=1)):(s=t.lastIndexOf(n,e-1),s!=-1&&!i&&(s+=1)),s}function ht(e,t,n){var r=t.line;n=n?n:e.getLine(r).charAt(t.ch);var i=k(n,["(","[","{"]),s={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{"}[n];if(!s)return t;var o={"(":1,"{":1,"[":1}[n]||-1,u=1,a=n,f=t.ch,l=e.getLine(r);while(a&&u>0)f+=o,a=l.charAt(f),a||(r+=o,f=0,l=e.getLine(r)||"",a=l.charAt(f)),a===n?u++:a===s&&u--;return a?{line:r,ch:f}:t}function pt(e,t,n){var r=e.getCursor(),i=ht(e,r,t),s=ht(e,i);return s.ch+=n?1:0,i.ch+=n?0:1,{start:s,end:i}}function dt(e,t,n){for(var r=n?n:e.length;r>=0;--r)if(t.test(e.charAt(r)))return r;return-1}function vt(e,t,n){var r=e.getCursor(),i=e.getLine(r.line),s=i.split(""),o,u,a,f,l=s.indexOf(t);r.ch<l?r.ch=l:l<r.ch&&s[r.ch]==t&&(u=r.ch,--r.ch);if(s[r.ch]==t&&!u)o=r.ch+1;else for(a=r.ch;a>-1&&!o;a--)s[a]==t&&(o=a+1);if(o&&!u)for(a=o,f=s.length;a<f&&!u;a++)s[a]==t&&(u=a);return!o||!u?{start:r,end:r}:(n&&(--o,++u),{start:{line:r.line,ch:o},end:{line:r.line,ch:u}})}function mt(){this.marked=null}function gt(e){var t=O(e);return t.searchState_||(t.searchState_=new mt)}function yt(e,t,n,r,i){e.openDialog?e.openDialog(t,r,{bottom:!0,value:i}):r(prompt(n,""))}function bt(e){var t=!1,n=[];for(var r=0;r<e.length;r++){var i=e.charAt(r);!t&&i=="/"&&n.push(r),t=i=="\\"}return n}function wt(e,t,n,r){var i=bt(t),s,o;if(!i.length)s=t;else{s=t.substring(0,i[0]);var u=t.substring(i[0]);o=u.indexOf("i")!=-1}if(!s)return null;r&&(n=/^[^A-Z]*$/.test(s));try{var a=new RegExp(s,n||o?"i":undefined);return a}catch(f){Et(e,"Invalid regex: "+s)}}function Et(e,t){e.openConfirm?e.openConfirm('<span style="color: red">'+t+'</span> <button type="button">OK</button>',function(){},{bottom:!0}):alert(t)}function St(e,t){var n="";return e&&(n+='<span style="font-family: monospace">'+e+"</span>"),n+='<input type="text"/> <span style="color: #888">',t&&(n+='<span style="color: #888">',n+=t,n+="</span>"),n}function Tt(e,t,n,r,i){var s=(n||"")+" "+(r||"");yt(e,St(n,r),s,t,i)}function Nt(e,t){if(e instanceof RegExp&&t instanceof RegExp){var n=["global","multiline","ignoreCase","source"];for(var r=0;r<n.length;r++){var i=n[r];if(e[i]!==t[i])return!1}return!0}return!1}function Ct(e,t,n,r){e.operation(function(){var i=gt(e);if(!t)return;var s=wt(e,t,!!n,!!r);if(!s)return;if(Nt(s,i.getQuery()))return;Ot(e),Lt(e,s),i.setQuery(s)})}function kt(e){return{token:function(t){var n=t.match(e,!1);if(n){if(!t.sol()){t.backUp(1);if(!e.exec(t.next()+n[0]))return t.next(),null}return t.match(e),"searching"}while(!t.eol()){t.next();if(t.match(e,!1))break}},query:e}}function Lt(e,t){if(e.addOverlay){var n=gt(e).getOverlay();if(!n||t!=n.query)n&&e.removeOverlay(n),n=kt(t),e.addOverlay(n),gt(e).setOverlay(n)}else if(e.lineCount()<2e3){var r=[];for(var i=e.getSearchCursor(t);i.findNext();)r.push(e.markText(i.from(),i.to(),{className:"cm-searching"}));gt(e).setMarked(r)}}function At(e,t,n){return e.operation(function(){var r=gt(e),i=r.getQuery();if(!i)return;r.getMarked()||Lt(e,i);var s=e.getCursor();t=r.isReversed()?!t:t,t||(s.ch+=1);var o=e.getSearchCursor(i,s);for(var u=0;u<n;u++)if(!o.find(t)){o=e.getSearchCursor(i,t?{line:e.lineCount()-1}:{line:0,ch:0});if(!o.find(t))return}return o.from()})}function Ot(e){e.addOverlay?(e.removeOverlay(gt(e).getOverlay()),gt(e).setOverlay(null)):e.operation(function(){var t=gt(e);if(!t.getQuery())return;var n=t.getMarked();if(!n)return;for(var r=0;r<n.length;++r)n[r].clear();t.setMarked(null)})}function Mt(e,t,n){return typeof e!="number"&&(e=e.line),t instanceof Array?k(e,t):n?e>=t&&e<=n:e==t}function Dt(e){var t=0,n=[];while(t<e.length){if(e.charAt(t)!="<"){n.push(e.charAt(t)),t++;continue}var r=++t;while(e.charAt(t++)!=">");var i=e.substring(r,t-1),s=/^C-(.+)$/.exec(i);if(s){var o;switch(s[1]){case"BS":o="Backspace";break;case"CR":o="Enter";break;case"Del":o="Delete";break;default:o=s[1]}n.push("Ctrl-"+o)}}return n}function Bt(){function e(e,t,r){S(t)&&(r=="Shift"?r=null:t=t.toLowerCase()),r&&(t=r+"-"+t),n.handleKey(e,t)}function t(t,n){return function(r){e(r,t,n)}}function s(e,n){for(var r=0;r<e.length;r++){var s=e[r];!n&&k(s,p)&&(s="'"+s+"'"),n?i[n+"-"+s]=t(e[r],n):i[s]=t(e[r])}}var r=["Shift","Ctrl"],i={nofallthrough:!0,style:"fat-cursor"};return s(f),s(f,"Shift"),s(f,"Ctrl"),s(p),s(p,"Ctrl"),s(c),s(c,"Ctrl"),s(d),s(d,"Ctrl"),i}function jt(e){e.setCursor(e.getCursor().line,e.getCursor().ch-1,!0),e.setOption("keyMap","vim")}var r=/[A-Za-z]/,i=/[\d]/,s=/\s/,o=[/\w/,/[^\w\s]/],u=[/\S/],f=a(65,26),l=a(97,26),c=a(48,10),h="~`!@#$%^&*()_-+=[{}]\\|/?.,<>:;\"'",p=h.split(""),d=["Left","Right","Up","Down","Space","Backspace","Esc","Home","End","PageUp","PageDown"],v=f.concat(l).concat(c).concat(["<",">"]),m=f.concat(l).concat(c).concat('-"'.split("")),L,M={buildKeyMap:function(){},getRegisterController:function(){return A().registerController},clearVimGlobalState_:function(){L=null},map:function(e,t){Ht.map(e,t)},maybeInitState:function(e){O(e)},handleKey:function(t,n){var r,i=O(t);if(n=="Esc"){i.inputState.reset(),i.visualMode&&tt(t,i);return}i.visualMode&&K(t.getCursor("head"),t.getCursor("anchor"))&&tt(t,i),!i.visualMode&&!K(t.getCursor("head"),t.getCursor("anchor"))&&(i.visualMode=!0,i.visualLine=!1);if(n!="0"||n=="0"&&i.inputState.getRepeat()===0)r=H.matchCommand(n,e,i);if(!r){E(n)&&i.inputState.pushRepeatDigit(n);return}if(r.type=="keyToKey")for(var s=0;s<r.toKeys.length;s++)this.handleKey(t,r.toKeys[s]);else H.processCommand(t,i,r)}};_.prototype.reset=function(){this.prefixRepeat=[],this.motionRepeat=[],this.operator=null,this.operatorArgs=null,this.motion=null,this.motionArgs=null,this.keyBuffer=[],this.registerName=null},_.prototype.pushRepeatDigit=function(e){this.operator?this.motionRepeat=this.motionRepeat.concat(e):this.prefixRepeat=this.prefixRepeat.concat(e)},_.prototype.getRepeat=function(){var e=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0)e=1,this.prefixRepeat.length>0&&(e*=parseInt(this.prefixRepeat.join(""),10)),this.motionRepeat.length>0&&(e*=parseInt(this.motionRepeat.join(""),10));return e},D.prototype={set:function(e,t){this.text=e,this.linewise=!!t},append:function(e,t){t||this.linewise?(this.text+="\n"+e,this.linewise=!0):this.text+=e},clear:function(){this.text="",this.linewise=!1},toString:function(){return this.text}},P.prototype={pushText:function(e,t,n,r){var i=this.isValidRegister(e)?this.getRegister(e):null;if(!i){switch(t){case"yank":this.registers[0]=new D(n,r);break;case"delete":case"change":n.indexOf("\n")==-1?this.registers["-"]=new D(n,r):(this.shiftNumericRegisters_(),this.registers[1]=new D(n,r))}this.unamedRegister.set(n,r);return}var s=S(e);s?(i.append(n,r),this.unamedRegister.append(n,r)):(i.set(n,r),this.unamedRegister.set(n,r))},getRegister:function(e){return this.isValidRegister(e)?(e=e.toLowerCase(),this.registers[e]||(this.registers[e]=new D),this.registers[e]):this.unamedRegister},isValidRegister:function(e){return e&&k(e,m)},shiftNumericRegisters_:function(){for(var e=9;e>=2;e--)this.registers[e]=this.getRegister(""+(e-1))}};var H={matchCommand:function(e,t,n){var r=n.inputState,i=r.keyBuffer.concat(e);for(var s=0;s<t.length;s++){var o=t[s];if(X(i,o.keys)){if(i.length<o.keys.length)return r.keyBuffer.push(e),null;if(r.operator&&o.type=="action")continue;return o.keys[i.length-1]=="character"&&(r.selectedCharacter=i[i.length-1]),r.keyBuffer=[],o}}return r.keyBuffer=[],null},processCommand:function(e,t,n){switch(n.type){case"motion":this.processMotion(e,t,n);break;case"operator":this.processOperator(e,t,n);break;case"operatorMotion":this.processOperatorMotion(e,t,n);break;case"action":this.processAction(e,t,n);break;case"search":this.processSearch(e,t,n);break;case"ex":case"keyToEx":this.processEx(e,t,n);break;default:}},processMotion:function(e,t,n){t.inputState.motion=n.motion,t.inputState.motionArgs=U(n.motionArgs),this.evalInput(e,t)},processOperator:function(e,t,n){var r=t.inputState;if(r.operator){if(r.operator==n.operator){r.motion="expandToLine",r.motionArgs={linewise:!0},this.evalInput(e,t);return}r.reset()}r.operator=n.operator,r.operatorArgs=U(n.operatorArgs),t.visualMode&&this.evalInput(e,t)},processOperatorMotion:function(e,t,n){var r=t.visualMode,i=U(n.operatorMotionArgs);i&&r&&i.visualLine&&(t.visualLine=!0),this.processOperator(e,t,n),r||this.processMotion(e,t,n)},processAction:function(e,t,n){var r=t.inputState,i=r.getRepeat(),s=!!i,o=U(n.actionArgs)||{};r.selectedCharacter&&(o.selectedCharacter=r.selectedCharacter),n.operator&&this.processOperator(e,t,n),n.motion&&this.processMotion(e,t,n),(n.motion||n.operator)&&this.evalInput(e,t),o.repeat=i||1,o.repeatIsExplicit=s,o.registerName=r.registerName,r.reset(),t.lastMotion=null,F[n.action](e,o,t)},processSearch:function(e,t,n){function s(n,r,i){Ct(e,n,r,i),H.processMotion(e,t,{type:"motion",motion:"findNext"})}function o(e){s(e,!0,!0)}if(!e.getSearchCursor)return;var r=n.searchArgs.forward;gt(e).setReversed(!r);var i=r?"/":"?";switch(n.searchArgs.querySrc){case"prompt":Tt(e,o,i,xt);break;case"wordUnderCursor":var u=st(e,!1,!0,!1,!0),a=!0;u||(u=st(e,!1,!0,!1,!1),a=!1);if(!u)return;var f=e.getLine(u.start.line).substring(u.start.ch,u.end.ch+1);a?f="\\b"+f+"\\b":f=et(f),e.setCursor(u.start),s(f,!0,!1)}},processEx:function(e,t,n){function r(t){Ht.processCommand(e,t)}n.type=="keyToEx"?Ht.processCommand(e,n.exArgs.input):t.visualMode?Tt(e,r,":",undefined,"'<,'>"):Tt(e,r,":")},evalInput:function(e,t){var n=t.inputState,r=n.motion,i=n.motionArgs||{},s=n.operator,o=n.operatorArgs||{},u=n.registerName,a=e.getCursor("head"),f=e.getCursor("anchor"),l=J(a),c=J(l),h,p;i.repeat!==undefined?p=n.motionArgs.repeat:p=n.getRepeat();if(p>0&&i.explicitRepeat)i.repeatIsExplicit=!0;else if(i.noRepeat||!i.explicitRepeat&&p===0)p=1,i.repeatIsExplicit=!1;n.selectedCharacter&&(i.selectedCharacter=o.selectedCharacter=n.selectedCharacter),i.repeat=p,n.reset();if(r){var d=B[r](e,i,t);t.lastMotion=B[r];if(!d)return;d instanceof Array?(l=d[0],h=d[1]):h=d,h||(h={ch:l.ch,line:l.line}),t.visualMode?(Q(f,a)&&(K(f,h)||Q(h,f))?f.ch+=1:Q(a,f)&&(K(f,h)||Q(f,h))&&(f.ch-=1),a=h,t.visualLine&&(Q(f,a)?(f.ch=0,a.ch=G(e,a.line)):(a.ch=0,f.ch=G(e,f.line))),e.setCursor(f),e.setSelection(f,a),lt(e,t,"<",Q(f,a)?f:a),lt(e,t,">",Q(f,a)?a:f)):s||(h=q(e,h),e.setCursor(h.line,h.ch))}if(s){var v=!1;t.lastMotion=null,o.repeat=p,t.visualMode&&(l=f,h=a,i.inclusive=!0);if(Q(h,l)){var m=l;l=h,h=m,v=!0}i.inclusive&&(!t.visualMode||!v)&&h.ch++;var g=i.linewise||t.visualMode&&t.visualLine;g?rt(e,l,h):i.forward&&nt(e,l,h),o.registerName=u,o.linewise=g,j[s](e,o,t,l,h,c),t.visualMode&&tt(e,t),o.enterInsertMode&&F.enterInsertMode(e)}}},B={expandToLine:function(e,t){var n=e.getCursor();return{line:n.line+t.repeat-1,ch:Infinity}},findNext:function(e,t,n){return At(e,!1,t.repeat)},findPrev:function(e,t,n){return At(e,!0,t.repeat)},goToMark:function(e,t,n){var r=n.marks[t.selectedCharacter];return r?r.find():null},moveByCharacters:function(e,t){var n=e.getCursor(),r=t.repeat,i=t.forward?n.ch+r:n.ch-r;return{line:n.line,ch:i}},moveByLines:function(e,t,n){var r=e.getCursor().ch;switch(n.lastMotion){case this.moveByLines:case this.moveToColumn:case this.moveToEol:r=n.lastHPos;break;default:n.lastHPos=r}var i=e.getCursor(),s=t.repeat,o=t.forward?i.line+s:i.line-s;return o<0||o>e.lineCount()-1?null:{line:o,ch:r}},moveByPage:function(e,t){var n=e.getCursor(),r=t.repeat;e.moveV(t.forward?r:-r,"page");var i=e.getCursor();return e.setCursor(n),i},moveByParagraph:function(e,t){var n=e.getCursor().line,r=t.repeat,i=t.forward?1:-1;for(var s=0;s<r;s++){if(!t.forward&&n===0||t.forward&&n==e.lineCount()-1)break;n+=i;while(n!==0&&n!=e.lineCount-1&&e.getLine(n))n+=i}return{line:n,ch:0}},moveByWords:function(e,t){return ut(e,t.repeat,!!t.forward,!!t.wordEnd,!!t.bigWord)},moveTillCharacter:function(e,t){var n=t.repeat,r=at(e,n,t.forward,t.selectedCharacter),i=t.forward?-1:1;return r.ch+=i,r},moveToCharacter:function(e,t){var n=t.repeat;return at(e,n,t.forward,t.selectedCharacter)},moveToColumn:function(e,t,n){var r=t.repeat;return n.lastHPos=r-1,ft(e,r)},moveToEol:function(e,t,n){var r=e.getCursor();return n.lastHPos=Infinity,{line:r.line+t.repeat-1,ch:Infinity}},moveToFirstNonWhiteSpaceCharacter:function(e){var t=e.getCursor(),n=e.getLine(t.line);return{line:t.line,ch:it(e.getLine(t.line))}},moveToMatchedSymbol:function(e,t){var n=e.getCursor(),r=e.getLine(n.line).charAt(n.ch);return w(r)?ht(e,e.getCursor(),t.symbol):n},moveToStartOfLine:function(e){var t=e.getCursor();return{line:t.line,ch:0}},moveToLineOrEdgeOfDocument:function(e,t){var n=t.forward?e.lineCount()-1:0;return t.repeatIsExplicit&&(n=t.repeat-1),{line:n,ch:it(e.getLine(n))}},textObjectManipulation:function(e,t){var n=t.selectedCharacter,r=!t.textObjectInner;if(!I[n])return null;var i=I[n](e,r),s=i.start,o=i.end;return[s,o]}},j={change:function(e,t,n,r,i){A().registerController.pushText(t.registerName,"change",e.getRange(r,i),t.linewise),t.linewise?(r.ch=it(e.getLine(r.line)),e.replaceRange("\n",r,i)):e.replaceRange("",r,i),e.setCursor(r)},"delete":function(e,t,n,r,i){A().registerController.pushText(t.registerName,"delete",e.getRange(r,i),t.linewise),e.replaceRange("",r,i),t.linewise?e.setCursor(B.moveToFirstNonWhiteSpaceCharacter(e)):e.setCursor(r)},indent:function(e,t,n,r,i){var s=r.line,o=i.line,u=n.visualMode?t.repeat:1;t.linewise&&o--;for(var a=s;a<=o;a++)for(var f=0;f<u;f++)e.indentLine(a,t.indentRight);e.setCursor(r),e.setCursor(B.moveToFirstNonWhiteSpaceCharacter(e))},swapcase:function(e,t,n,r,i,s){var o=e.getRange(r,i),u="";for(var a=0;a<o.length;a++){var f=o.charAt(a);u+=S(f)?f.toLowerCase():f.toUpperCase()}e.replaceRange(u,r,i),e.setCursor(s)},yank:function(e,t,n,r,i,s){A().registerController.pushText(t.registerName,"yank",e.getRange(r,i),t.linewise),e.setCursor(s)}},F={clearSearchHighlight:Ot,enterInsertMode:function(e,t){var n=t?t.insertAt:null;if(n=="eol"){var r=e.getCursor();r={line:r.line,ch:G(e,r.line)},e.setCursor(r)}else n=="charAfter"&&e.setCursor(z(e.getCursor(),0,1));e.setOption("keyMap","vim-insert")},toggleVisualMode:function(e,t,n){var r=t.repeat,i=e.getCursor(),s;n.visualMode?(i=e.getCursor("anchor"),s=e.getCursor("head"),!n.visualLine&&t.linewise?(n.visualLine=!0,i.ch=Q(i,s)?0:G(e,i.line),s.ch=Q(i,s)?G(e,s.line):0,e.setSelection(i,s)):n.visualLine&&!t.linewise?n.visualLine=!1:tt(e,n)):(n.visualMode=!0,n.visualLine=!!t.linewise,n.visualLine?(i.ch=0,s=q(e,{line:i.line+r-1,ch:G(e,i.line)},!0)):s=q(e,{line:i.line,ch:i.ch+r},!0),!t.repeatIsExplicit&&!n.visualLine?(e.setCursor(s),e.setSelection(s,i)):e.setSelection(i,s)),lt(e,n,"<",Q(i,s)?i:s),lt(e,n,">",Q(i,s)?s:i)},joinLines:function(e,t,n){var r,i;if(n.visualMode)r=e.getCursor("anchor"),i=e.getCursor("head"),i.ch=G(e,i.line)-1;else{var s=Math.max(t.repeat,2);r=e.getCursor(),i=q(e,{line:r.line+s-1,ch:Infinity})}var o=0;e.operation(function(){for(var t=r.line;t<i.line;t++){o=G(e,r.line);var n={line:r.line+1,ch:G(e,r.line+1)},s=e.getRange(r,n);s=s.replace(/\n\s*/g," "),e.replaceRange(s,r,n)}var u={line:r.line,ch:o};e.setCursor(u)})},newLineAndEnterInsertMode:function(e,t){var n=e.getCursor();if(n.line===0&&!t.after)e.replaceRange("\n",{line:0,ch:0}),e.setCursor(0,0);else{n.line=t.after?n.line:n.line-1,n.ch=G(e,n.line),e.setCursor(n);var r=CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent;r(e)}this.enterInsertMode(e)},paste:function(e,t,n){var r=e.getCursor(),i=A().registerController.getRegister(t.registerName);if(!i.text)return;for(var s="",o=0;o<t.repeat;o++)s+=i.text;var u=i.linewise;u?t.after?(s="\n"+s.slice(0,s.length-1),r.ch=G(e,r.line)):r.ch=0:r.ch+=t.after?1:0,e.replaceRange(s,r);var a,f;u&&t.after?a={line:r.line+1,ch:it(e.getLine(r.line+1))}:u&&!t.after?a={line:r.line,ch:it(e.getLine(r.line))}:!u&&t.after?(f=e.indexFromPos(r),a=e.posFromIndex(f+s.length-1)):(f=e.indexFromPos(r),a=e.posFromIndex(f+s.length)),e.setCursor(a)},undo:function(e,t){$(e,CodeMirror.commands.undo,t.repeat)()},redo:function(e,t){$(e,CodeMirror.commands.redo,t.repeat)()},setRegister:function(e,t,n){n.inputState.registerName=t.selectedCharacter},setMark:function(e,t,n){var r=t.selectedCharacter;lt(e,n,r,e.getCursor())},replace:function(e,t){var n=t.selectedCharacter,r=e.getCursor(),i=e.getLine(r.line),s=r.ch+t.repeat;if(s>i.length)return;var o={line:r.line,ch:s},u="";for(var a=0;a<o.ch-r.ch;a++)u+=n;e.replaceRange(u,r,o),e.setCursor(z(o,0,-1))}},I={w:function(e,t){return st(e,t,!0,!1)},W:function(e,t){return st(e,t,!0,!0)},"{":function(e,t){return pt(e,"}",t)},"(":function(e,t){return pt(e,")",t)},"[":function(e,t){return pt(e,"]",t)},"'":function(e,t){return vt(e,"'",t)},'"':function(e,t){return vt(e,'"',t)}};mt.prototype={getQuery:function(){return A().query},setQuery:function(e){A().query=e},getMarked:function(){return this.marked},setMarked:function(e){this.marked=e},getOverlay:function(){return this.searchOverlay},setOverlay:function(e){this.searchOverlay=e},isReversed:function(){return A().isReversed},setReversed:function(e){A().isReversed=e}};var xt="(Javascript regexp)",_t=[{name:"map",type:"builtIn"},{name:"write",shortName:"w",type:"builtIn"},{name:"undo",shortName:"u",type:"builtIn"},{name:"redo",shortName:"red",type:"builtIn"},{name:"substitute",shortName:"s",type:"builtIn"}];t.ExCommandDispatcher=function(){this.buildCommandMap_()},t.ExCommandDispatcher.prototype={processCommand:function(e,t){var r=new CodeMirror.StringStream(t),i={};i.input=t;try{this.parseInput_(e,r,i)}catch(s){Et(e,s);return}var o;if(!i.commandName)i.line!==undefined&&(o="move");else{var u=this.matchCommand_(i.commandName);if(u){o=u.name,this.parseCommandArgs_(r,i,u);if(u.type=="exToKey"){for(var a=0;a<u.toKeys.length;a++)n.handleKey(e,u.toKeys[a]);return}if(u.type=="exToEx"){this.processCommand(e,u.toInput);return}}}if(!o){Et(e,'Not an editor command ":'+t+'"');return}Pt[o](e,i)},parseInput_:function(e,t,n){t.eatWhile(":"),t.eat("%")?(n.line=0,n.lineEnd=e.lineCount()-1):(n.line=this.parseLineSpec_(e,t),n.line!==undefined&&t.eat(",")&&(n.lineEnd=this.parseLineSpec_(e,t)));var r=t.match(/^(\w+)/);return r?n.commandName=r[1]:n.commandName=t.match(/.*/)[0],n},parseLineSpec_:function(e,t){var n=t.match(/^(\d+)/);if(n)return parseInt(n[1],10)-1;switch(t.next()){case".":return e.getCursor().line;case"$":return e.lineCount()-1;case"'":var r=O(e).marks[t.next()];if(r&&r.find())return r.find().line;throw"Mark not set";default:return t.backUp(1),e.getCursor().line}},parseCommandArgs_:function(e,t,n){if(e.eol())return;t.argString=e.match(/.*/)[0];var r=n.argDelimiter||/\s+/,i=Z(t.argString).split(r);i.length&&i[0]&&(t.args=i)},matchCommand_:function(e){for(var t=e.length;t>0;t--){var n=e.substring(0,t);if(this.commandMap_[n]){var r=this.commandMap_[n];if(r.name.indexOf(e)===0)return r}}return null},buildCommandMap_:function(){this.commandMap_={};for(var e=0;e<_t.length;e++){var t=_t[e],n=t.shortName||t.name;this.commandMap_[n]=t}},map:function(t,n){if(t!=":"&&t.charAt(0)==":"){var r=t.substring(1);n!=":"&&n.charAt(0)==":"?this.commandMap_[r]={name:r,type:"exToEx",toInput:n.substring(1)}:this.commandMap_[r]={name:r,type:"exToKey",toKeys:Dt(n)}}else n!=":"&&n.charAt(0)==":"?e.unshift({keys:Dt(t),type:"keyToEx",exArgs:{input:n.substring(1)}}):e.unshift({keys:Dt(t),type:"keyToKey",toKeys:Dt(n)})}};var Pt={map:function(e,t){var n=t.args;if(!n||n.length<2){e&&Et(e,"Invalid mapping: "+t.input);return}Ht.map(n[0],n[1],e)},move:function(e,t){H.processMotion(e,O(e),{motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0,repeat:t.line}})},substitute:function(e,t){function d(){for(var t=e.getSearchCursor(l,p);t.findNext()&&Mt(t.from(),c,h);){var n=e.getRange(t.from(),t.to()),r=n.replace(l,s);t.replace(r)}var i=O(e);i.visualMode&&tt(e,i)}var n=t.argString,r=bt(n);if(r[0]!==0){Et(e,"Substitutions should be of the form :s/pattern/replace/");return}var i=n.substring(r[0]+1,r[1]),s="",o,u;r[1]&&(s=n.substring(r[1]+1,r[2]));if(r[2]){var a=n.substring(r[2]+1).split(" ");o=a[0],u=parseInt(a[1])}o&&(i=i+"/"+o),i&&Ct(e,i,!0,!0);var f=gt(e),l=f.getQuery(),c=t.line||0,h=t.lineEnd||c;u&&(c=h,h=c+u-1);var p=q(e,{line:c,ch:0});e.compoundChange?e.compoundChange(d):e.operation(d)},redo:CodeMirror.commands.redo,undo:CodeMirror.commands.undo,write:function(e){CodeMirror.commands.save?CodeMirror.commands.save(e):e.save()}},Ht=new t.ExCommandDispatcher;return CodeMirror.keyMap.vim=Bt(),CodeMirror.keyMap["vim-insert"]={Esc:jt,"Ctrl-[":jt,"Ctrl-C":jt,"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(e){var t=CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent;t(e)},fallthrough:["default"]},M},n=t();CodeMirror.Vim=n})();